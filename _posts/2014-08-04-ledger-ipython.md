---
layout: post
title: Сравнение расходов по периодам используя IPython
lang: ru
category: finance
image: http://i.imgur.com/u9QmYip.png
---

В [ledger], где я веду бухгалтерию, можно вывести отчет по доходам или расходам
за произвольный период. Но часто хочется сравнить несколько разных периодов.
Конечно, можно вывести несколько отчетов, сохранить их в файлы и потом сравнить
diffом. Но, если так сделать, то получится очень плохо. Во-первых, в стандартном
формате вывода у ledger вначале идут суммы и только за ними категории. Diff в
таком случае покажет все строки как отличающиеся. Также будет совершенно
ненаглядно, потому что категории могут не совпадать. Поэтому, нужна некая
сводная таблица, в которой были бы категории и расходы по ним по месяцам.

<!--more-->

Для вывода отчетов за текущий месяц, у меня определены следующие команды в
`.zshrc`:

    alias equity="ledger balance Assets Liabilities $@"
    alias expenses="ledger balance Expenses -p 'this month' --start-of-week=1 $@"
    alias netincome="ledger balance --collapse --invert Income Expenses --start-of-week=1 -p 'this month' $@"
    alias income="ledger balance Income --invert --start-of-week=1 -p 'this month' $@"

Эти команды выводят текущие остатки на счетах (equity), расходы и доходы.

Наша задача --- сделать несколько отчетов за периоды, затем свести их в одну
сводную таблицу. Ledger позволяет задать формат отчета, в котором он будет
выводить данные. Чтобы получился валидный CSV файл нужно задать следующий
формат:

    --format '"%(account)","%(display_total)"\n'


Сначала я решил код для сравнения попробовать написать на языке [clojure], про
который я сейчас читаю. Заодно будет некая тестовая задача. Писал дня 2, в
итоге написал загрузку данных из CSV-файлов (по одному на каждый месяц) и их
соединение (full outer join). Осталось только написать вывод в файл. Кода
получилось много (для функционального языка), но с синтаксисом clojure я
разобрался. [Гист с написанным кодом][clojure-gist]. Дальше я продолжать не
стал, потому что решать такую задачу не изучив все возможности языка --- пустая
трата времени, будешь разрабатывать крайне неоптимально.

А сегодня я вспомнил про [IPython], интерактивную среду для Python с уклоном в
статистическую обработку данных и представление информации. Давно хотел его
попробовать в деле, вот и задачка подвернулась. Скачал, установил. Сначала долго
пытался разобраться с magic функциями IPython (которые не питоновские функции а
функции оболочки IPython). Пытался через `%alias` создать функцию, которая
будет по месяцу выгружать отчет из ledger. Оказалось, что IPython как-то очень
странно работает с параметрами.

Вот пример:

    In [1]: %alias e echo one \"%s\" two \"%s\" three \"%s\"

    In [2]: e a b c
    one "a" two "b" three "c"

    In [3]: e "a b c" b c
    one "a" two "b" three "c" b c

    In [4]: e "its a kind of magic"
    one "its" two "a" three "kind" of magic

Вообще не понимаю, почему такое происходит и как передать параметр в
magic-функцию строку, содержащую пробел.

В итоге, я отказался от использования magic-функций и вызываю в цикле выполнение
команды, записанной в строковую переменную.

Я, по аналогии с clojure, сначала реализовал собственную фукнцию соединения двух
словарей а когда начал читать о выводе данных в табличном виде, наткнулся на
библиотеку [pandas], которая выводит данные в табличном виде. Также у этой
библиотеки есть функции соединения датасетов на подобие джойнов в SQL. Моя
задача это по сути FULL OUTER JOIN всех анализируемых датасетов.

В итоге, помимо сравнения месяцев, я туда добавил и столбец с бюджетом на месяц
а также суммарную информацию с начала года.

Получившийся ноутбук IPython можно посмотреть и скачать [здесь][notebook].

[ledger]: {% post_url 2014-04-12-ledger %}
[clojure]: http://clojure.org
[IPython]: http://ipython.org
[pandas]: http://pandas.pydata.org
[1]: http://iseetheline.ru/assets/ledger-ipython.html
[clojure-gist]: https://gist.github.com/schmooser/b57f0484d2d7e2903c91
[notebook]: http://nbviewer.ipython.org/gist/schmooser/af0ec7287e4bf425dee5

